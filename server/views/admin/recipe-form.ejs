<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('../partials/head') %>
    <!-- Form validation styles -->
    <link rel="stylesheet" href="/css/validation.css">
</head>

<body>
  <%- include('../partials/nav') %>

    <div class="container mt-4">
      <div class="row">
        <div class="col-12">
          <!-- Header -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
              <% if (mode==='edit' ) { %>
                ‚úèÔ∏è Edit Recipe: <%= recipe.name %>
                  <% } else { %>
                    ‚ûï Create New Recipe
                    <% } %>
            </h1>
            <a href="/admin" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
          </div>

          <!-- Error Alert -->
          <% if (error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <%= error %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <% } %>

              <!-- Recipe Form -->
              <div class="card">
                <div class="card-body">
                  <form id="recipeForm" method="POST" action="/admin/recipes/preview">
                    <!-- Hidden fields for mode and original name -->
                    <input type="hidden" name="mode" value="<%= mode %>">
                    <% if (mode==='edit' && recipe) { %>
                      <input type="hidden" name="originalName" value="<%= recipe.name %>">
                      <% } %>

                        <div class="row">
                          <!-- Basic Info Column -->
                          <div class="col-md-8">
                            <!-- Recipe Name -->
                            <div class="mb-3">
                              <label for="name" class="form-label">Recipe Name * <small class="text-muted">(max 50
                                  characters)</small></label>
                              <input type="text" class="form-control" id="name" name="name"
                                value="<%= recipe ? recipe.name : '' %>" maxlength="50" required>
                            </div>

                            <!-- Description -->
                            <div class="mb-3">
                              <label for="description" class="form-label">Description <small class="text-muted">(max
                                  200 characters)</small></label>
                              <textarea class="form-control" id="description" name="description" rows="3"
                                maxlength="200"
                                placeholder="A brief description of your recipe..."><%= recipe ? recipe.description : '' %></textarea>
                            </div>

                            <!-- Ingredients Section -->
                            <div class="mb-4">
                              <label class="form-label">Ingredients *</label>
                              <div id="ingredientsContainer">
                                <% if (recipe && recipe.ingredients && recipe.ingredients.length> 0) { %>
                                  <% recipe.ingredients.forEach((ingredient, index)=> { %>
                                    <div class="ingredient-row mb-3">
                                      <div class="card">
                                        <div class="card-body">
                                          <div class="row g-2">
                                            <div class="col-md-2">
                                              <label class="form-label small">Amount *</label>
                                              <input type="number" class="form-control form-control-sm"
                                                name="ingredient_amount_<%= index + 1 %>"
                                                value="<%= ingredient.amount %>" placeholder="2" min="0.01" step="0.01"
                                                required>
                                            </div>
                                            <div class="col-md-2">
                                              <label class="form-label small">Unit *</label>
                                              <select class="form-select form-select-sm"
                                                name="ingredient_unit_<%= index + 1 %>" required>
                                                <option value="">-- Select Unit --</option>
                                                <% measurementUnits.forEach(unit=> { %>
                                                  <option value="<%= unit %>" <%=ingredient.unit===unit ? 'selected'
                                                    : '' %>>
                                                    <%= unit %>
                                                  </option>
                                                  <% }); %>
                                              </select>
                                            </div>
                                            <div class="col-md-4">
                                              <label class="form-label small">Ingredient *
                                                <small class="text-muted">(max 30 chars)</small>
                                              </label>
                                              <input type="text" class="form-control form-control-sm"
                                                name="ingredient_name_<%= index + 1 %>"
                                                value="<%= ingredient.ingredient %>" placeholder="flour" maxlength="30"
                                                required>
                                            </div>
                                            <div class="col-md-3">
                                              <label class="form-label small">Note (optional)
                                                <small class="text-muted">(max 100 chars)</small>
                                              </label>
                                              <input type="text" class="form-control form-control-sm"
                                                name="ingredient_note_<%= index + 1 %>"
                                                value="<%= ingredient.note || '' %>" placeholder="room temperature"
                                                maxlength="100">
                                            </div>
                                            <div class="col-md-1">
                                              <label class="form-label small">&nbsp;</label>
                                              <button type="button"
                                                class="btn btn-outline-danger btn-sm remove-ingredient d-block">
                                                üóëÔ∏è
                                              </button>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                    <% }); %>
                                      <% } else { %>
                                        <div class="ingredient-row mb-3">
                                          <div class="card">
                                            <div class="card-body">
                                              <div class="row g-2">
                                                <div class="col-md-2">
                                                  <label class="form-label small">Amount *</label>
                                                  <input type="number" class="form-control form-control-sm"
                                                    name="ingredient_amount_1" placeholder="2" min="0.01" step="0.01"
                                                    required>
                                                </div>
                                                <div class="col-md-2">
                                                  <label class="form-label small">Unit *</label>
                                                  <select class="form-select form-select-sm" name="ingredient_unit_1"
                                                    required>
                                                    <option value="">-- Select Unit --</option>
                                                    <% if (measurementUnits) { %>
                                                      <% measurementUnits.forEach(unit=> { %>
                                                        <option value="<%= unit %>">
                                                          <%= unit %>
                                                        </option>
                                                        <% }); %>
                                                          <% } %>
                                                  </select>
                                                </div>
                                                <div class="col-md-4">
                                                  <label class="form-label small">Ingredient * <small
                                                      class="text-muted">(max 30 chars)</small></label>
                                                  <input type="text" class="form-control form-control-sm"
                                                    name="ingredient_name_1" placeholder="flour" maxlength="30"
                                                    required>
                                                </div>
                                                <div class="col-md-3">
                                                  <label class="form-label small">Note (optional) <small
                                                      class="text-muted">(max 100 chars)</small></label>
                                                  <input type="text" class="form-control form-control-sm"
                                                    name="ingredient_note_1" placeholder="room temperature"
                                                    maxlength="100">
                                                </div>
                                                <div class="col-md-1">
                                                  <label class="form-label small">&nbsp;</label>
                                                  <button type="button"
                                                    class="btn btn-outline-danger btn-sm remove-ingredient d-block">
                                                    üóëÔ∏è
                                                  </button>
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                        <% } %>
                              </div>
                              <button type="button" id="addIngredient" class="btn btn-outline-primary btn-sm mt-2">
                                ‚ûï Add Ingredient
                              </button>
                            </div>

                            <!-- Cooking Steps Section -->
                            <div class="mb-4">
                              <label class="form-label">Cooking Steps *</label>
                              <div id="stepsContainer">
                                <% if (recipe && recipe.steps) { %>
                                  <% recipe.steps.forEach((step, index)=> { %>
                                    <div class="step-row mb-3">
                                      <label class="form-label">Step <%= index + 1 %></label>
                                      <div class="input-group mb-2">
                                        <textarea class="form-control" name="step_<%= index + 1 %>" rows="2"
                                          maxlength="500"
                                          placeholder="Describe this cooking step... (max 500 characters)"
                                          required><%= typeof step === 'string' ? step : step.description %></textarea>
                                        <button type="button" class="btn btn-outline-danger remove-step">
                                          üóëÔ∏è
                                        </button>
                                      </div>
                                      <!-- Note field for step -->
                                      <div class="ms-4">
                                        <div class="form-check mb-2">
                                          <input class="form-check-input step-note-toggle" type="checkbox"
                                            id="noteToggle_<%= index + 1 %>" <%=(typeof step==='object' && step.note)
                                            ? 'checked' : '' %>>
                                          <label class="form-check-label" for="noteToggle_<%= index + 1 %>">
                                            üí° Add special note for this step
                                          </label>
                                        </div>
                                        <div class="step-note-field"
                                          style="display: <%= (typeof step === 'object' && step.note) ? 'block' : 'none' %>">
                                          <textarea class="form-control form-control-sm"
                                            name="step_note_<%= index + 1 %>" rows="2" maxlength="100"
                                            placeholder="Add a special note or tip for this step... (max 100 characters)"><%= (typeof step === 'object' && step.note) ? step.note : '' %></textarea>
                                        </div>
                                      </div>
                                    </div>
                                    <% }); %>
                                      <% } else { %>
                                        <div class="step-row mb-3">
                                          <label class="form-label">Step 1</label>
                                          <div class="input-group mb-2">
                                            <textarea class="form-control" name="step_1" rows="2" maxlength="500"
                                              placeholder="Describe this cooking step... (max 500 characters)"
                                              required></textarea>
                                            <button type="button" class="btn btn-outline-danger remove-step">
                                              üóëÔ∏è
                                            </button>
                                          </div>
                                          <!-- Note field for step -->
                                          <div class="ms-4">
                                            <div class="form-check mb-2">
                                              <input class="form-check-input step-note-toggle" type="checkbox"
                                                id="noteToggle_1">
                                              <label class="form-check-label" for="noteToggle_1">
                                                üí° Add special note for this step
                                              </label>
                                            </div>
                                            <div class="step-note-field" style="display: none">
                                              <textarea class="form-control form-control-sm" name="step_note_1" rows="2"
                                                maxlength="100"
                                                placeholder="Add a special note or tip for this step... (max 100 characters)"></textarea>
                                            </div>
                                          </div>
                                        </div>
                                        <% } %>
                              </div>
                              <button type="button" id="addStep" class="btn btn-outline-primary btn-sm mt-2">
                                ‚ûï Add Step
                              </button>
                            </div>
                          </div>

                          <!-- Recipe Details Column -->
                          <div class="col-md-4">
                            <!-- Cook Time -->
                            <div class="mb-3">
                              <label for="cook_time" class="form-label">Cook Time (minutes) *</label>
                              <input type="number" class="form-control" id="cook_time" name="cook_time"
                                value="<%= recipe ? recipe.cook_time : '' %>" min="0" required>
                            </div>

                            <!-- Default Portions -->
                            <div class="mb-3">
                              <label for="default_portions" class="form-label">Default Portions *</label>
                              <input type="number" class="form-control" id="default_portions" name="default_portions"
                                value="<%= recipe ? recipe.default_portions || recipe.servings : '2' %>" min="1"
                                required>
                            </div>

                            <!-- Difficulty -->
                            <div class="mb-3">
                              <label for="difficulty" class="form-label">Difficulty *</label>
                              <select class="form-select" id="difficulty" name="difficulty" required>
                                <option value="">-- Select Difficulty --</option>
                                <% if (difficultyLevels) { %>
                                  <% difficultyLevels.forEach(level=> { %>
                                    <option value="<%= level %>" <%=recipe && recipe.difficulty===level ? 'selected'
                                      : '' %>>
                                      <%= level.charAt(0).toUpperCase() + level.slice(1) %>
                                    </option>
                                    <% }); %>
                                      <% } %>
                              </select>
                            </div>

                            <!-- Categories -->
                            <div class="mb-3">
                              <label for="categories" class="form-label">Categories</label>
                              <div class="form-check-group">
                                <% const selectedCategories=recipe && recipe.categories ? recipe.categories : []; %>
                                  <% if (typeof availableCategories !==' undefined' && availableCategories &&
                                    availableCategories.length> 0) { %>
                                    <% availableCategories.forEach(category=> { %>
                                      <% const isChecked=selectedCategories.includes(category); %>
                                        <div class="form-check">
                                          <input class="form-check-input" type="checkbox" name="categories"
                                            value="<%= category %>" id="category_<%= category %>" <%=isChecked
                                            ? 'checked' : '' %>
                                          >
                                          <label class="form-check-label" for="category_<%= category %>">
                                            <%= category.charAt(0).toUpperCase() + category.slice(1) %>
                                          </label>
                                        </div>
                                        <% }); %>
                                          <% } else { %>
                                            <p class="text-muted">No categories available</p>
                                            <% } %>
                              </div>
                              <small class="form-text text-muted">Select one or more categories that apply to this
                                recipe.</small>
                            </div>

                            <!-- Recipe Images -->
                            <div class="mb-4">
                              <h5>üì∏ Recipe Images</h5>
                              <div id="imagesContainer">
                                <% if (recipe && recipe.images && recipe.images.length> 0) { %>
                                  <% recipe.images.forEach((image, index)=> { %>
                                    <div class="image-row mb-3 p-3 border rounded">
                                      <div class="row g-2">
                                        <div class="col-md-5">
                                          <label class="form-label small">Image URL/Path <small class="text-muted">(max
                                              100 chars)</small></label>
                                          <input type="text" class="form-control" name="image_url_<%= index + 1 %>"
                                            value="<%= image.link || '' %>" maxlength="100"
                                            placeholder="beef.jpg or https://..." list="image-suggestions">
                                          <small class="text-muted">Type to search recipe images, or paste external
                                            URL</small>
                                        </div>
                                        <div class="col-md-5">
                                          <label class="form-label small">Description * <small class="text-muted">(max
                                              20 chars)</small></label>
                                          <input type="text" class="form-control" name="image_desc_<%= index + 1 %>"
                                            value="<%= image.description || '' %>" maxlength="20"
                                            placeholder="Image description" required>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end pb-0">
                                          <button type="button"
                                            class="btn btn-outline-danger btn-sm w-100 remove-image mb-0">
                                            üóëÔ∏è Remove
                                          </button>
                                        </div>
                                      </div>
                                      <% if (image.link) { %>
                                        <div class="mt-2">
                                          <small class="text-muted">Preview:</small><br>
                                          <img src="<%= image.link %>" alt="<%= image.description || 'Recipe image' %>"
                                            class="img-thumbnail" style="max-width: 150px; max-height: 100px;">
                                        </div>
                                        <% } %>
                                    </div>
                                    <% }); %>
                                      <% } else { %>
                                        <div class="image-row mb-3 p-3 border rounded">
                                          <div class="row g-2">
                                            <div class="col-md-5">
                                              <label class="form-label small">Image URL/Path <small
                                                  class="text-muted">(max 100 chars)</small></label>
                                              <input type="text" class="form-control" name="image_url_1" maxlength="100"
                                                placeholder="beef.jpg or https://..." list="image-suggestions">
                                              <small class="text-muted">Type to search recipe images, or paste
                                                external URL</small>
                                              <datalist id="image-suggestions">
                                                <option>/content/recipes/beef.jpg</option>
                                                <option>/content/recipes/pancake.jpg</option>
                                                <option>/content/recipes/waffles.jpg</option>
                                                <option>/images/logo.png</option>
                                                <option>https://example.com/image.jpg</option>
                                              </datalist>
                                            </div>
                                            <div class="col-md-5">
                                              <label class="form-label small">Description * <small
                                                  class="text-muted">(max 20 chars)</small></label>
                                              <input type="text" class="form-control" name="image_desc_1" maxlength="20"
                                                placeholder="Image description" required>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end pb-0">
                                              <button type="button"
                                                class="btn btn-outline-danger btn-sm w-100 remove-image mb-0">
                                                üóëÔ∏è Remove
                                              </button>
                                            </div>
                                          </div>
                                        </div>
                                        <% } %>
                              </div>
                              <div class="d-flex gap-2">
                                <button type="button" id="addImage" class="btn btn-outline-primary btn-sm">
                                  ‚ûï Add Image
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal"
                                  data-bs-target="#uploadImageModal">
                                  üì§ Upload New Image
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row mt-4">
                          <div class="col-12">
                            <div class="d-flex gap-2">
                              <button type="submit" class="btn btn-info">
                                üëÄ Preview Recipe
                              </button>
                              <button type="button" class="btn btn-success" onclick="saveDirectly()">
                                üíæ Save Recipe
                              </button>
                              <a href="/admin" class="btn btn-outline-secondary">
                                Cancel
                              </a>
                            </div>
                          </div>
                        </div>
                  </form>
                </div>
              </div>
        </div>
      </div>
    </div>

    <!-- Image Upload Modal (must be before script loads) -->
    <div class="modal fade" id="uploadImageModal" tabindex="-1" aria-labelledby="uploadImageModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadImageModalLabel">üì§ Upload Recipe Image</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Upload Area -->
            <div id="uploadDropZone" class="border-2 border-dashed rounded p-4 text-center"
              style="border-color: #dee2e6; cursor: pointer; transition: all 0.3s;">
              <div id="uploadIcon">
                <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                <p class="mt-3 mb-2"><strong>Drag & drop</strong> your image here</p>
                <p class="text-muted small">or click to browse</p>
                <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                <button type="button" class="btn btn-outline-primary btn-sm"
                  onclick="document.getElementById('imageFileInput').click()">
                  Choose File
                </button>
                <p class="text-muted small mt-2">Max size: 5MB ‚Ä¢ JPG, PNG, GIF, WEBP</p>
              </div>
            </div>

            <!-- Preview Area (hidden initially) -->
            <div id="uploadPreview" style="display: none;">
              <img id="previewImage" src="" alt="Preview" class="img-fluid rounded mb-3" style="max-height: 300px;">
              <div class="alert alert-info d-flex align-items-center">
                <i class="bi bi-info-circle me-2"></i>
                <div>
                  <strong id="previewFilename"></strong><br>
                  <small id="previewFilesize" class="text-muted"></small>
                </div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div id="uploadProgress" class="mt-3" style="display: none;">
              <div class="progress">
                <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                  role="progressbar" style="width: 0%"></div>
              </div>
              <p class="text-center mt-2 small text-muted">Uploading...</p>
            </div>

            <!-- Success Message -->
            <div id="uploadSuccess" class="alert alert-success mt-3" style="display: none;">
              <i class="bi bi-check-circle me-2"></i>
              <strong>Success!</strong> Image uploaded successfully.
            </div>

            <!-- Error Message -->
            <div id="uploadError" class="alert alert-danger mt-3" style="display: none;">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <strong>Error!</strong> <span id="uploadErrorMessage"></span>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="uploadButton" class="btn btn-success" disabled>
              <i class="bi bi-upload"></i> Upload Image
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Pass server data to JavaScript -->
    <script>
      // Server data injection for external JavaScript
      window.recipeFormData = {
        measurementUnits: <% - JSON.stringify(measurementUnits || ['gram', 'litre', 'dl', 'ts', 'ss', 'small', 'medium', 'large']) %>,
        ingredientCount: <%= recipe && recipe.ingredients ? recipe.ingredients.length : 1 %>,
        stepCount: <%= recipe && recipe.steps ? recipe.steps.length : 1 %>,
          imageCount: <%= recipe && recipe.images ? recipe.images.length : 1 %>
        };
    </script>

    <!-- External JavaScript for recipe form functionality -->
    <script src="/js/recipe-form.js"></script>

    <%- include('../partials/footer') %>
</body>

</html>